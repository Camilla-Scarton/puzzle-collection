<div *ngIf="layout.layoutMode() === 'grid'"
    class="mb-8 flex flex-col sm:flex-row gap-4 justify-between items-center bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700/50">
    <!-- Filter -->
    <div class="flex items-center gap-3 w-full sm:w-auto">
        <label class="text-sm font-medium text-gray-400 whitespace-nowrap">Status:</label>
        <div class="relative w-full sm:w-48">
            <select [ngModel]="puzzleService.filterStatus()" (ngModelChange)="puzzleService.filterStatus.set($event)"
                class="w-full appearance-none bg-gray-900 border border-gray-700 text-gray-300 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-900 focus:border-indigo-500 transition-colors cursor-pointer text-sm">
                <option value="all">All Puzzles</option>
                <option value="completed">Completed</option>
                <option value="in-progress">In Progress</option>
                <option value="wishlist">Wishlist</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                </svg>
            </div>
        </div>
    </div>

    <!-- Sort -->
    <div class="flex items-center gap-3 w-full sm:w-auto">
        <label class="text-sm font-medium text-gray-400 whitespace-nowrap">Sort by:</label>
        <div class="relative w-full sm:w-48">
            <select [ngModel]="sortOption()" (ngModelChange)="sortOption.set($event)"
                class="w-full appearance-none bg-gray-900 border border-gray-700 text-gray-300 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-900 focus:border-indigo-500 transition-colors cursor-pointer text-sm">
                <option value="newest">Newest First</option>
                <option value="title">Title (A-Z)</option>
                <option value="pieces_desc">Pieces (Most)</option>
                <option value="pieces_asc">Pieces (Least)</option>
                <option value="rating">Rating</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                </svg>
            </div>
        </div>
    </div>
</div>

<!-- Results Count -->
<div *ngIf="layout.layoutMode() === 'grid'" class="mb-4 text-sm text-gray-400 font-medium">
    Showing {{ visiblePuzzles().length }} puzzles
</div>

<div [class.grid]="layout.layoutMode() === 'grid'" [class.grid-cols-1]="layout.layoutMode() === 'grid'"
    [class.md:grid-cols-2]="layout.layoutMode() === 'grid'" [class.lg:grid-cols-3]="layout.layoutMode() === 'grid'"
    [class.gap-8]="layout.layoutMode() === 'grid'" [class.columns-1]="layout.layoutMode() === 'masonry'"
    [class.gap-6]="layout.layoutMode() === 'masonry'" [class.max-w-3xl]="layout.layoutMode() === 'masonry'"
    [class.mx-auto]="layout.layoutMode() === 'masonry'" [class.pb-24]="layout.layoutMode() === 'masonry'">
    <app-puzzle-card *ngFor="let puzzle of visiblePuzzles(); let i = index" [id]="'puzzle-' + puzzle.id"
        [puzzle]="puzzle" [layoutMode]="layout.layoutMode()" [isActive]="highlightedPuzzleId() === puzzle.id"
        (mouseenter)="highlightedPuzzleId.set(puzzle.id)"
        [style.zIndex]="highlightedPuzzleId() === puzzle.id ? 9999 : (visiblePuzzles().length - i)"
        class="block break-inside-avoid transition-all duration-500 ease-out"
        [class.h-full]="layout.layoutMode() === 'grid'" [class.-mt-[13px]]="layout.layoutMode() === 'masonry'"
        [class.first:mt-0]="layout.layoutMode() === 'masonry'"
        [class.relative]="layout.layoutMode() === 'masonry'"></app-puzzle-card>

    <!-- Empty State -->
    <div *ngIf="visiblePuzzles().length === 0" class="col-span-full py-12 text-center text-gray-500">
        <div class="mb-2 text-4xl">ðŸ§©</div>
        <p>No puzzles found matching your criteria.</p>
    </div>
</div>

<!-- Mini Map Sidebar (Masonry Only) -->
<div *ngIf="layout.layoutMode() === 'masonry' && visiblePuzzles().length > 0"
    class="fixed right-6 top-1/2 -translate-y-1/2 flex flex-col gap-2 z-20 max-h-[80vh] overflow-y-auto hidden xl:flex p-2 bg-gray-900/50 backdrop-blur-md rounded-2xl border border-gray-700/50 shadow-xl">
    <button *ngFor="let puzzle of visiblePuzzles()" (click)="scrollToPuzzle('puzzle-' + puzzle.id)"
        [id]="'minimap-btn-' + puzzle.id"
        class="relative group w-12 h-12 rounded-lg overflow-hidden border-2 transition-all shrink-0 focus:outline-none focus:border-indigo-500"
        [class.border-transparent]="highlightedPuzzleId() !== puzzle.id"
        [class.border-indigo-500]="highlightedPuzzleId() === puzzle.id" title="{{ puzzle.title }}">
        <img [src]="puzzle.imageUrl"
            class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity"
            [alt]="puzzle.title">
    </button>
</div>