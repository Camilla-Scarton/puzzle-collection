<div *ngIf="layout.layoutMode() === 'grid'"
    class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700/50">

    <!-- Left Column: Brand & Status -->
    <div class="flex flex-col gap-4 h-full justify-between">
        <!-- Brand Filter -->
        <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-gray-400">Brand</label>
            <div class="relative">
                <select [ngModel]="puzzleService.filterBrand()" (ngModelChange)="puzzleService.filterBrand.set($event)"
                    class="w-full appearance-none bg-gray-900 border border-gray-700 text-gray-300 py-2.5 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-900 focus:border-indigo-500 transition-colors cursor-pointer text-sm">
                    <option value="all">All Brands</option>
                    <option *ngFor="let brand of puzzleService.getBrands()" [value]="brand">{{ brand }}</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Status Filter -->
        <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-gray-400">Status</label>
            <div class="relative">
                <select [ngModel]="puzzleService.filterStatus()"
                    (ngModelChange)="puzzleService.filterStatus.set($event)"
                    class="w-full appearance-none bg-gray-900 border border-gray-700 text-gray-300 py-2.5 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-900 focus:border-indigo-500 transition-colors cursor-pointer text-sm">
                    <option value="all">All Statuses</option>
                    <option value="completed">Completed</option>
                    <option value="in-progress">In Progress</option>
                    <option value="wishlist">Wishlist</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Piece Count & Sort -->
    <div class="flex flex-col gap-4 h-full justify-between">
        <!-- Piece Count Filter -->
        <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-gray-400">Piece Count</label>
            <div class="relative">
                <select [ngModel]="puzzleService.filterPieceCount()"
                    (ngModelChange)="puzzleService.filterPieceCount.set($event)"
                    class="w-full appearance-none bg-gray-900 border border-gray-700 text-gray-300 py-2.5 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-900 focus:border-indigo-500 transition-colors cursor-pointer text-sm">
                    <option value="all">All Sizes</option>
                    <option *ngFor="let count of puzzleService.getPieceCounts()" [value]="count">{{ count }} pieces
                    </option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Sort -->
        <div class="flex flex-col gap-1">
            <label class="text-sm font-medium text-gray-400">Sort by</label>
            <div class="relative">
                <select [ngModel]="sortOption()" (ngModelChange)="sortOption.set($event)"
                    class="w-full appearance-none bg-gray-900 border border-gray-700 text-gray-300 py-2.5 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-gray-900 focus:border-indigo-500 transition-colors cursor-pointer text-sm">
                    <option value="newest">Newest First</option>
                    <option value="title">Title (A-Z)</option>
                    <option value="pieces_desc">Pieces (Most)</option>
                    <option value="pieces_asc">Pieces (Least)</option>
                    <option value="rating">Rating</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Results Count -->
<div *ngIf="layout.layoutMode() === 'grid'" class="mb-4 text-sm text-gray-400 font-medium">
    Showing {{ visiblePuzzles().length }} puzzles
</div>

<div [class.grid]="layout.layoutMode() === 'grid'" [class.grid-cols-1]="layout.layoutMode() === 'grid'"
    [class.md:grid-cols-2]="layout.layoutMode() === 'grid'" [class.lg:grid-cols-3]="layout.layoutMode() === 'grid'"
    [class.gap-8]="layout.layoutMode() === 'grid'" [class.columns-1]="layout.layoutMode() === 'masonry'"
    [class.gap-6]="layout.layoutMode() === 'masonry'" [class.max-w-3xl]="layout.layoutMode() === 'masonry'"
    [class.mx-auto]="layout.layoutMode() === 'masonry'" [class.pb-24]="layout.layoutMode() === 'masonry'">
    <app-puzzle-card *ngFor="let puzzle of visiblePuzzles(); let i = index" [id]="'puzzle-' + puzzle.id"
        [puzzle]="puzzle" [layoutMode]="layout.layoutMode()" [isActive]="highlightedPuzzleId() === puzzle.id"
        [isFirst]="i === 0" (mouseenter)="!isScrolling && highlightedPuzzleId.set(puzzle.id)"
        (imageClick)="imageClick.emit($event)"
        [style.zIndex]="highlightedPuzzleId() === puzzle.id ? 9999 : (visiblePuzzles().length - i)"
        class="block break-inside-avoid transition-all duration-500 ease-out"
        [class.h-full]="layout.layoutMode() === 'grid'" [class.-mt-[13px]]="layout.layoutMode() === 'masonry'"
        [class.first:mt-0]="layout.layoutMode() === 'masonry'"
        [class.relative]="layout.layoutMode() === 'masonry'"></app-puzzle-card>

    <!-- Empty State -->
    <div *ngIf="visiblePuzzles().length === 0" class="col-span-full py-12 text-center text-gray-500">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="w-12 h-12 fill-current mx-auto mb-4">
            <path
                d="M288 64C323.3 64 352 85.5 352 112C352 122.4 347.6 132 340 139.9C333.4 146.8 328 155.2 328 164.8C328 179.8 340.2 192 355.2 192L400 192C426.5 192 448 213.5 448 240L448 284.8C448 299.8 460.2 312 475.2 312C484.7 312 493.2 306.6 500.1 300C508 292.5 517.6 288 528 288C554.5 288 576 316.7 576 352C576 387.3 554.5 416 528 416C517.6 416 507.9 411.6 500.1 404C493.2 397.4 484.8 392 475.2 392C460.2 392 448 404.2 448 419.2L448 528C448 554.5 426.5 576 400 576L343.2 576C330.4 576 320 565.6 320 552.8C320 543.6 325.8 535.5 333.2 530C344.8 521.3 352 509.3 352 496C352 469.5 323.3 448 288 448C252.7 448 224 469.5 224 496C224 509.3 231.2 521.3 242.8 530C250.2 535.5 256 543.5 256 552.8C256 565.6 245.6 576 232.8 576L112 576C85.5 576 64 554.5 64 528L64 407.2C64 394.4 74.4 384 87.2 384C96.4 384 104.5 389.8 110 397.2C118.7 408.8 130.7 416 144 416C170.5 416 192 387.3 192 352C192 316.7 170.5 288 144 288C130.7 288 118.7 295.2 110 306.8C104.5 314.2 96.5 320 87.2 320C74.4 320 64 309.6 64 296.8L64 240C64 213.5 85.5 192 112 192L220.8 192C235.8 192 248 179.8 248 164.8C248 155.3 242.6 146.8 236 139.9C228.5 132 224 122.4 224 112C224 85.5 252.7 64 288 64z" />
        </svg>
        <p>No puzzles found matching your criteria.</p>
    </div>
</div>

<!-- Mini Map Sidebar (Masonry Only) -->
<div *ngIf="layout.layoutMode() === 'masonry' && visiblePuzzles().length > 0"
    class="minimap-container fixed flex gap-3 z-[10000] p-3 bg-gray-900/80 backdrop-blur-xl rounded-2xl border border-gray-700/50 shadow-2xl transition-all duration-300"
    [class.at-bottom]="layout.isAtBottom()">
    <button *ngFor="let puzzle of visiblePuzzles()" (click)="scrollToPuzzle('puzzle-' + puzzle.id)"
        [id]="'minimap-btn-' + puzzle.id"
        class="relative group w-12 h-12 rounded-lg overflow-hidden border-2 transition-all shrink-0"
        [class.border-transparent]="highlightedPuzzleId() !== puzzle.id"
        [class.border-indigo-500]="highlightedPuzzleId() === puzzle.id" title="{{ puzzle.title }}">
        <img [src]="puzzle.imageUrl"
            class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity"
            [alt]="puzzle.title">
    </button>
</div>